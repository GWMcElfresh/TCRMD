name: tcrmd-pipeline
on:
  push:
    branches: [main, "copilot/**"]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy pytest pytest-cov

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=tcrmd --cov-report=xml --cov-report=term-missing

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  model_complex:
    name: Model TCR-pMHC Complex
    runs-on: ubuntu-latest
    needs: test
    # Only run the full pipeline on manual dispatch or when a pMHC data file
    # is pushed, to avoid exhausting free runner minutes on every commit.
    if: >
      github.event_name == 'workflow_dispatch' ||
      contains(github.event.head_commit.message, '[run-pipeline]')
    steps:
      - uses: actions/checkout@v4

      - name: Build Docker image
        run: docker build -t pmhc-md .

      - name: Run pipeline
        run: |
          mkdir -p results
          docker run \
            --memory="14g" \
            -v ${{ github.workspace }}:/data \
            pmhc-md \
            /data/run_pipeline.py \
              --sequences /data/sequences.json \
              --template /data/template.pdb \
              --checkpoint /data/boltz1.ckpt \
              --output /data/results \
              --num-steps 50000 \
              --platform CPU

      - name: Upload results
        uses: actions/upload-artifact@v4
        with:
          name: pMHC-TCR-Analysis
          path: results/
